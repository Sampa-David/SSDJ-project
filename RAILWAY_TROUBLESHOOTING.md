# Railway Deployment Troubleshooting Guide

## ğŸ”§ Configuration Checklist

### 1. Composer Dependencies
```bash
# âœ… Check: heroku/heroku-buildpack-php NOT in composer.json
grep -i heroku composer.json
# Should return: (nothing)
```

### 2. Environment Setup
```bash
# âœ… Check: .env.production exists
test -f .env.production && echo "âœ… .env.production exists" || echo "âŒ Missing"

# âœ… Check: APP_KEY format
grep "^APP_KEY=base64:" .env.production
# Should output: APP_KEY=base64:...
```

### 3. Database Configuration
```bash
# âœ… Verify in .env.production:
DB_HOST=ssdj-db              # Service name (not IP)
DB_DATABASE=ssdj             # Database name
DB_USERNAME=railway          # Must match MYSQL_USER
DB_PASSWORD=railway          # Must match MYSQL_PASSWORD
```

### 4. Deployment Script
```bash
# âœ… Check permissions
test -x bin/railway-deploy.sh && echo "âœ… Script is executable" || echo "âŒ Not executable"

# âœ… Check content (no /app references)
grep -n "/app" bin/railway-deploy.sh
# Should return: (nothing)
```

### 5. Procfile Validation
```bash
# âœ… Must contain:
cat Procfile
# Expected: web: php -S 0.0.0.0:${PORT:-8080} -t public
```

## ğŸš€ Manual Deployment Steps

### Step 1: Prepare Code
```bash
# Update composer (local)
composer install --no-dev --optimize-autoloader

# Clear caches
php artisan config:clear
php artisan cache:clear

# Test locally
php artisan serve
```

### Step 2: Push to GitHub
```bash
git add -A
git commit -m "Clean: Remove Heroku config, Railway ready"
git push origin main
```

### Step 3: Deploy on Railway
```bash
# Via railway CLI (if installed)
railway deploy

# OR manually via Dashboard:
# 1. https://railway.app/dashboard
# 2. Select project
# 3. Deployments tab
# 4. Click "Redeploy" on latest commit
```

### Step 4: Monitor Deployment
```bash
# View logs in real-time
railway logs --service web --tail

# Test endpoint
curl -I https://web-production-b7b89.up.railway.app/
# Expected: HTTP 200 or 302 (redirect to login)
```

## ğŸ› Common Issues & Solutions

### Issue: "heroku-php-apache2: command not found"
**Cause:** Procfile still referencing Heroku
**Fix:**
```bash
# Verify Procfile contains:
cat Procfile
# Should be: web: php -S 0.0.0.0:${PORT:-8080} -t public

# Update and push:
git add Procfile && git commit -m "Fix Procfile" && git push
```

### Issue: "php-fpm: command not found"
**Cause:** Old buildpack cache or Heroku configs
**Fix:**
```bash
# Clear Railway cache:
# Via Dashboard:
# 1. Settings
# 2. "Clear build cache"
# 3. Redeploy

# Verify composer.json has NO Heroku dependency:
grep -i heroku composer.json  # Should be empty
```

### Issue: "DB connection refused"
**Cause:** Wrong DB_HOST or database not ready
**Fix:**
```bash
# Verify in railway.yaml:
cat railway.yaml | grep -A5 "database:"

# DB_HOST MUST be: ssdj-db (not localhost or IP)
# Wait 30 seconds after deployment for MySQL to initialize
# Check Railway logs for MySQL startup messages
```

### Issue: "502 Bad Gateway"
**Cause:** App crashed or database not initialized
**Debug:**
```bash
# Check Railway logs:
railway logs --service web --all

# Common causes:
# 1. APP_KEY not set â†’ auto-generated by railway-deploy.sh âœ…
# 2. Database not migrated â†’ handled by railway-deploy.sh âœ…
# 3. Missing .env values â†’ use .env.production âœ…
# 4. Port mismatch â†’ set to 8080 âœ…
```

### Issue: "Connection timeout"
**Cause:** Health check failing, app not starting
**Debug Steps:**
```bash
# 1. Check build logs completed
# 2. Verify startCommand works locally:
php -S 0.0.0.0:8080 -t public

# 3. Check if app responds (may take 30sec after start):
sleep 30 && curl http://localhost:8080

# 4. Verify database is running:
# Railway Dashboard â†’ Services â†’ ssdj-db â†’ Status
```

## ğŸ“Š Health Check Indicators

**Green = Success:**
âœ… Deployment: "Active"
âœ… Service web: "Running"
âœ… Service database: "Running"
âœ… Build logs: "Build successful"
âœ… HTTP response: 200 or 302 (not 502)

**Red = Problem:**
âŒ Deployment: "Build Failed" or "Crashed"
âŒ Service status: "Error" or "Starting" (> 2min)
âŒ HTTP: 502, 503, 504
âŒ Build logs: Error messages

## ğŸ” Production Security

Verify production setup:

```bash
# âœ… Check: APP_DEBUG=false
grep "APP_DEBUG=false" .env.production

# âœ… Check: APP_ENV=production
grep "APP_ENV=production" .env.production

# âœ… Check: HTTPS enabled (Railway auto-enables)
curl -I https://web-production-b7b89.up.railway.app/
# Should redirect http â†’ https

# âœ… Check: Database password NOT in code
grep -r "password.*123" app/ config/ routes/
# Should return: (nothing)
```

## ğŸ“ Support Resources

- Railway Docs: https://docs.railway.app
- Laravel on Railway: https://docs.railway.app/guides/laravel
- Railway Status: https://status.railway.app

---

**Last Updated:** 26 Nov 2025
**Status:** Ready for production deployment
